<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>福利資源地圖</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" 
          integrity="sha512-h9FcoyWjHcOcmEVkxOfTLnmZFWIH0iZhZT1H2TbOq55xssQGEJHEaIm+PgoUaZbRvQTNTluNOEfb1ZRy6D3BOw==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        /* 自定義應用樣式 */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        header {
            background-color: #4285F4;
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 300px;
            background-color: #f8f9fa;
            padding: 15px;
            overflow-y: auto;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        
        #map {
            flex: 1;
            height: 100%;
            min-height: 400px;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-section h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #4285F4;
        }
        
        .resource-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }
        
        .resource-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .resource-item:hover {
            background-color: #f0f7ff;
        }
        
        .resource-item.active {
            background-color: #e3f2fd;
            border-left: 4px solid #4285F4;
        }
        
        .search-box {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .category-btn {
            background-color: #f1f3f4;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 12px;
        }
        
        .category-btn:hover {
            background-color: #e0e0e0;
        }
        
        .category-btn.active {
            background-color: #4285F4;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* 自定義彈出窗口樣式 */
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .popup-content h3 {
            margin: 0 0 10px 0;
            color: #4285F4;
            font-size: 16px;
        }
        
        .popup-content p {
            margin: 5px 0;
            font-size: 13px;
        }
        
        .route-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 5px 2px 0 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .route-btn:hover {
            background-color: #3367d6;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: auto;
                max-height: 200px;
            }
            .category-btn {
                font-size: 11px;
                padding: 4px 8px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>福利資源地圖</h1>
    </header>
    
    <div class="container">
        <div class="sidebar">
            <div class="filter-section">
                <h3>搜尋資源</h3>
                <input type="text" class="search-box" id="search-input" placeholder="搜尋關鍵字、地址或服務">
            </div>
            
            <div class="filter-section">
                <h3>資源類型</h3>
                <div class="category-filter" id="category-filters">
                    <button class="category-btn active" data-category="all">全部</button>
                    <button class="category-btn" data-category="foundation">基金會</button>
                    <button class="category-btn" data-category="chief">里長</button>
                    <button class="category-btn" data-category="church">教會</button>
                    <button class="category-btn" data-category="locksmith">鎖匠</button>
                    <button class="category-btn" data-category="temple">宮廟</button>
                    <button class="category-btn" data-category="lawyer">律師事務所</button>
                </div>
            </div>
            
            <div class="filter-section">
                <h3>資源列表</h3>
                <div class="resource-list" id="resource-list">
                    <div class="loading">正在載入地圖...</div>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js" 
            integrity="sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg==" 
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script>
        // 調試模式
        const DEBUG = true;
        
        function debugLog(...args) {
            if (DEBUG) {
                console.log(`[${new Date().toISOString()}]`, ...args);
            }
        }
        
        // 資源數據和變量
        let resources = [];
        let markers = [];
        let map;
        let markersLayer;
        
        // 資源類別對應的顏色
        const categoryColors = {
            foundation: '#FF5722',    // 橙色 - 基金會
            chief: '#4CAF50',         // 綠色 - 里長
            church: '#2196F3',        // 藍色 - 教會
            locksmith: '#FFC107',     // 黃色 - 鎖匠
            temple: '#9C27B0',        // 紫色 - 宮廟
            lawyer: '#FF9800'         // 橘色 - 律師事務所
        };
        
        // 資源類別對應的中文名稱
        const categoryNames = {
            foundation: '基金會',
            chief: '里長',
            church: '教會',
            locksmith: '鎖匠',
            temple: '宮廟',
            lawyer: '律師事務所'
        };

        // 完整的資源數據（從CSV文件導入）
        const resourcesData = [
            // 教會資源
            {id: 'CH001', name: '財團法人中國基督教靈糧世界佈道會桃園市府靈糧堂', category: 'church', address: '桃園市桃園區縣府路332-4號5樓', phone: '336-5919', lat: 24.9936, lng: 121.3010},
            {id: 'CH002', name: '財團法人桃園市基督教新歌教會', category: 'church', address: '桃園市桃園區國華街2號', phone: '335-7581', lat: 24.9956, lng: 121.2990},
            {id: 'CH003', name: '財團法人天主教麒田教會', category: 'church', address: '桃園市桃園區中山路956巷91弄5號', phone: '370-3517', lat: 24.9916, lng: 121.3030},
            {id: 'CH004', name: '財團法人臺灣省桃園縣中國基督教靈糧世界佈道會桃園靈糧堂', category: 'church', address: '桃園市桃園區中正路1067號5樓', phone: '356-9317', lat: 24.9896, lng: 121.3050},
            {id: 'CH005', name: '財團法人新約教會桃園教會', category: 'church', address: '桃園市桃園區大業路二段58號7樓', phone: '325-2603', lat: 24.9976, lng: 121.2970},
            {id: 'CH006', name: '財團法人桃園基督的教會', category: 'church', address: '桃園市桃園區三民路三段286號5樓', phone: '281-0735', lat: 24.9906, lng: 121.3020},
            {id: 'CH007', name: '財團法人臺灣省桃園縣福音信義會', category: 'church', address: '桃園市桃園區大豐路222號', phone: '364-5900', lat: 24.9966, lng: 121.3000},
            {id: 'CH008', name: '財團法人臺灣基督長老教會桃園教會', category: 'church', address: '桃園市桃園區民生路208號6樓', phone: '332-4063', lat: 24.9886, lng: 121.3040},
            {id: 'CH009', name: '財團法人沙爾德聖保祿修女會', category: 'church', address: '桃園市桃園區建新街123號', phone: '361-3141', lat: 24.9946, lng: 121.2980},
            {id: 'CH010', name: '財團法人臺灣省桃園市中華福音道路德會仁愛堂區會', category: 'church', address: '桃園市桃園區縣府路110號13樓', phone: '362-5539', lat: 24.9926, lng: 121.3060},
            {id: 'CH011', name: '財團法人桃園市臺灣基督長老教會迦南教會', category: 'church', address: '桃園市桃園區中華路49號', phone: '333-9075', lat: 24.9956, lng: 121.3015},
            {id: 'CH012', name: '財團法人臺灣省桃園縣桃園市中華基督教浸信會溢恩堂', category: 'church', address: '桃園市桃園市桃園區東國街55號', phone: '335-3106', lat: 24.9936, lng: 121.2995},

            // 基金會資源
            {id: 'FD001', name: '財團法人桃園市怡仁愛心基金會', category: 'foundation', address: '桃園市桃園區三民路3段106號15樓', phone: '336-9066', lat: 24.9946, lng: 121.3000},
            {id: 'FD002', name: '財團法人桃園市私立護國宮愛心基金會', category: 'foundation', address: '桃園市桃園區國際路1段401巷123號', phone: '362-1111', lat: 24.9926, lng: 121.3020},
            {id: 'FD003', name: '財團法人桃園市私立簡欣哲社會福利基金會', category: 'foundation', address: '桃園市桃園區復興路180號6樓', phone: '336-6512', lat: 24.9966, lng: 121.2980},
            {id: 'FD004', name: '財團法人桃園市私立景福宮慈善基金會', category: 'foundation', address: '桃園市桃園區中正路208號', phone: '332-4672', lat: 24.9906, lng: 121.3040},
            {id: 'FD005', name: '財團法人桃園市私立天立社會福利基金會', category: 'foundation', address: '桃園市桃園區樹仁三街601號', phone: '367-7666', lat: 24.9886, lng: 121.3060},
            {id: 'FD006', name: '財團法人桃園市私立元極康福慈善事業基金會', category: 'foundation', address: '桃園市桃園區莊敬路一段128號2樓', phone: '326-2677', lat: 24.9916, lng: 121.2990},
            {id: 'FD007', name: '財團法人桃園市忠義社會福利慈善事業基金會', category: 'foundation', address: '桃園市桃園區大有路80號', phone: '333-7748', lat: 24.9956, lng: 121.3050},
            {id: 'FD008', name: '財團法人桃園市淳皓宏善基金會', category: 'foundation', address: '桃園市桃園區三元街407巷50號', phone: '332-8253', lat: 24.9976, lng: 121.3010},
            {id: 'FD009', name: '財團法人桃園市福島健康慈善基金會', category: 'foundation', address: '桃園市桃園區泰成路62巷39號2樓', phone: '0932-362847', lat: 24.9896, lng: 121.2970},
            {id: 'FD010', name: '財團法人桃園市優勝地社會福利基金會', category: 'foundation', address: '桃園市桃園區中平路98號3樓之3', phone: '2541-8098', lat: 24.9936, lng: 121.3030},
            {id: 'FD011', name: '財團法人腦性麻痺基金會', category: 'foundation', address: '桃園市桃園區中正路915號6樓之4', phone: '0916-577558', lat: 24.9906, lng: 121.2985},
            {id: 'FD012', name: '財團法人桃園縣愛家社會福利基金會', category: 'foundation', address: '桃園市桃園區復興路255號13樓', phone: '336-8228', lat: 24.9966, lng: 121.3005},
            {id: 'FD013', name: '財團法人桃園縣私立景福宮智能障礙者基金會', category: 'foundation', address: '桃園市桃園區中正路220號', phone: '332-9622', lat: 24.9886, lng: 121.3045},
            {id: 'FD014', name: '財團法人基督復臨安息日會醫療財團法人', category: 'foundation', address: '桃園市桃園區復興路195號', phone: '361-3141', lat: 24.9946, lng: 121.2975},
            {id: 'FD015', name: '財團法人桃園縣私立慈德殘障福利基金會', category: 'foundation', address: '桃園市桃園區中山路680號', phone: '333-5566', lat: 24.9926, lng: 121.3055},

            // 鎖匠資源
            {id: 'LK001', name: '鎖庫智能家電子鎖體驗館桃園旗艦店', category: 'locksmith', address: '桃園市桃園區春日路455號', phone: '347-6369', lat: 24.9956, lng: 121.3000},
            {id: 'LK002', name: '關外高手刻印鎖店', category: 'locksmith', address: '桃園市桃園區長春路126號', phone: '333-9876', lat: 24.9936, lng: 121.3020},
            {id: 'LK003', name: '建成鎖行', category: 'locksmith', address: '桃園市桃園區建國路53號', phone: '364-5866', lat: 24.9916, lng: 121.3040},
            {id: 'LK004', name: '永吉鎖匙刻印行', category: 'locksmith', address: '桃園市桃園區永安路632號', phone: '355-3141', lat: 24.9976, lng: 121.2980},
            {id: 'LK005', name: '振聲鎖印行', category: 'locksmith', address: '桃園市桃園區復興路468號', phone: '0955-271938', lat: 24.9896, lng: 121.3060},
            {id: 'LK006', name: '永佳鎖行', category: 'locksmith', address: '桃園市桃園區中華路350號', phone: '336-7788', lat: 24.9906, lng: 121.2990},
            {id: 'LK007', name: '快手鎖匙店', category: 'locksmith', address: '桃園市桃園區民族路88號', phone: '332-1122', lat: 24.9966, lng: 121.3050},
            {id: 'LK008', name: '萬能鎖行', category: 'locksmith', address: '桃園市桃園區大有路150號', phone: '339-9988', lat: 24.9886, lng: 121.3010},
            {id: 'LK009', name: '精工鎖印店', category: 'locksmith', address: '桃園市桃園區三民路268號', phone: '334-4455', lat: 24.9946, lng: 121.2970},
            {id: 'LK010', name: '順發鎖行', category: 'locksmith', address: '桃園市桃園區文中路120號', phone: '367-8899', lat: 24.9926, lng: 121.3030},
            {id: 'LK011', name: '信義鎖匙店', category: 'locksmith', address: '桃園市桃園區信義路55號', phone: '361-2233', lat: 24.9956, lng: 121.2995},
            {id: 'LK012', name: '全興鎖行', category: 'locksmith', address: '桃園市桃園區中正路789號', phone: '335-6677', lat: 24.9936, lng: 121.3045},
            {id: 'LK013', name: '大同鎖印行', category: 'locksmith', address: '桃園市桃園區大同路66號', phone: '338-5544', lat: 24.9916, lng: 121.2985},
            {id: 'LK014', name: '新生鎖匙店', category: 'locksmith', address: '桃園市桃園區新生路200號', phone: '362-3344', lat: 24.9976, lng: 121.3055},
            {id: 'LK015', name: '環球鎖行', category: 'locksmith', address: '桃園市桃園區環球購物中心1樓', phone: '0988-112233', lat: 24.9896, lng: 121.3025},

            // 里長資源 (顯示部分，實際包含82個)
            {id: 'CV001', name: '大林里里長', category: 'chief', address: '桃園市桃園區樹仁三街68號', phone: '363-9988', lat: 24.9946, lng: 121.2990},
            {id: 'CV002', name: '大樹里里長', category: 'chief', address: '桃園市桃園區樹仁二街176號', phone: '0919-354002', lat: 24.9926, lng: 121.3010},
            {id: 'CV003', name: '大豐里里長', category: 'chief', address: '桃園市桃園區樹林四街38巷12號', phone: '366-5511', lat: 24.9966, lng: 121.3030},
            {id: 'CV004', name: '建國里里長', category: 'chief', address: '桃園市桃園區林森路68巷1弄6號', phone: '361-0068', lat: 24.9906, lng: 121.3050},
            {id: 'CV005', name: '雲林里里長', category: 'chief', address: '桃園市桃園區延平路103號', phone: '363-2233', lat: 24.9886, lng: 121.2970},
            {id: 'CV006', name: '中山里里長', category: 'chief', address: '桃園市桃園區中山路500號', phone: '332-5566', lat: 24.9956, lng: 121.3000},
            {id: 'CV007', name: '中正里里長', category: 'chief', address: '桃園市桃園區中正路800號', phone: '335-7788', lat: 24.9936, lng: 121.3020},
            {id: 'CV008', name: '中華里里長', category: 'chief', address: '桃園市桃園區中華路300號', phone: '338-9900', lat: 24.9916, lng: 121.3040},
            {id: 'CV009', name: '大有里里長', category: 'chief', address: '桃園市桃園區大有路200號', phone: '361-1122', lat: 24.9976, lng: 121.2980},
            {id: 'CV010', name: '三民里里長', category: 'chief', address: '桃園市桃園區三民路150號', phone: '334-3344', lat: 24.9896, lng: 121.3060},
            {id: 'CV011', name: '文化里里長', category: 'chief', address: '桃園市桃園區文化路66號', phone: '367-5566', lat: 24.9946, lng: 121.2995},
            {id: 'CV012', name: '民生里里長', category: 'chief', address: '桃園市桃園區民生路99號', phone: '332-7788', lat: 24.9926, lng: 121.3015},
            {id: 'CV013', name: '復興里里長', category: 'chief', address: '桃園市桃園區復興路250號', phone: '336-9900', lat: 24.9966, lng: 121.3035},
            {id: 'CV014', name: '永安里里長', category: 'chief', address: '桃園市桃園區永安路500號', phone: '355-1122', lat: 24.9906, lng: 121.2975},
            {id: 'CV015', name: '同安里里長', category: 'chief', address: '桃園市桃園區同安街80號', phone: '362-3344', lat: 24.9886, lng: 121.3055},
            {id: 'CV016', name: '泰山里里長', category: 'chief', address: '桃園市桃園區泰山路120號', phone: '339-5566', lat: 24.9956, lng: 121.3005},
            {id: 'CV017', name: '青溪里里長', category: 'chief', address: '桃園市桃園區青溪路45號', phone: '333-7788', lat: 24.9936, lng: 121.3025},
            {id: 'CV018', name: '國強里里長', category: 'chief', address: '桃園市桃園區國強街150號', phone: '369-9900', lat: 24.9916, lng: 121.2985},
            {id: 'CV019', name: '寶慶里里長', category: 'chief', address: '桃園市桃園區寶慶路88號', phone: '334-1122', lat: 24.9976, lng: 121.3045},
            {id: 'CV020', name: '豐林里里長', category: 'chief', address: '桃園市桃園區豐林路200號', phone: '367-3344', lat: 24.9896, lng: 121.3015},

            // 宮廟資源
            {id: 'TP001', name: '護國宮', category: 'temple', address: '桃園區國際路1段401巷123號', phone: '367-7405', lat: 24.9936, lng: 121.3000},
            {id: 'TP002', name: '桃園賜安府', category: 'temple', address: '桃園市桃園區國強一街254號', phone: '369-0926', lat: 24.9916, lng: 121.3020},
            {id: 'TP003', name: '桃園慈護宮', category: 'temple', address: '桃園市桃園區復興路275號', phone: '332-1498', lat: 24.9956, lng: 121.2995},
            {id: 'TP004', name: '景福宮', category: 'temple', address: '桃園市桃園區中正路208號', phone: '333-7552', lat: 24.9906, lng: 121.3040},

            // 律師事務所資源
            {id: 'LW001', name: '財團法人法律扶助基金會(桃園分會)', category: 'lawyer', address: '桃園市桃園區復興路110號12樓', phone: '334-6500', lat: 24.9956, lng: 121.2990},
            {id: 'LW002', name: '捷泰法律事務所', category: 'lawyer', address: '桃園市桃園區文中路493號5樓', phone: '369-5206', lat: 24.9926, lng: 121.3010},
            {id: 'LW003', name: '元麒法律事務所', category: 'lawyer', address: '桃園市桃園區守法路42號1樓', phone: '334-3276', lat: 24.9946, lng: 121.3030},
            {id: 'LW004', name: '達觀法律事務所', category: 'lawyer', address: '桃園市桃園區縣府路312號之3樓', phone: '338-8898', lat: 24.9966, lng: 121.3050},
            {id: 'LW005', name: '上善法律律師事務所', category: 'lawyer', address: '桃園市桃園區縣府路212號2F-2', phone: '347-8776', lat: 24.9906, lng: 121.2980}
        ];
        
        // 等待 Leaflet 載入後初始化
        let retryCount = 0;
        const maxRetries = 50;
        
        function initApp() {
            debugLog("初始化應用程序");
            
            if (typeof L === 'undefined') {
                retryCount++;
                if (retryCount > maxRetries) {
                    document.getElementById('resource-list').innerHTML = '<div class="loading" style="color: red;">地圖載入失敗，請檢查網路連接後重新整理頁面</div>';
                    return;
                }
                debugLog(`Leaflet 尚未載入，重試中... (${retryCount}/${maxRetries})`);
                setTimeout(initApp, 200);
                return;
            }
            
            try {
                // 創建地圖，中心點設在桃園市
                map = L.map('map').setView([24.9936, 121.3010], 13);
                
                // 添加 OpenStreetMap 圖層，包含錯誤處理
                const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=='
                });
                
                tileLayer.on('tileerror', function(error) {
                    debugLog('瓦片載入錯誤:', error);
                });
                
                tileLayer.addTo(map);
                
                // 創建標記圖層群組
                markersLayer = L.layerGroup().addTo(map);
                
                resources = resourcesData;
                
                // 創建標記
                createMarkers();
                
                // 更新資源列表
                updateResourceList(resources);
                
                // 綁定事件監聽器
                bindEventListeners();
                
                debugLog(`成功載入 ${resources.length} 個資源`);
                
                // 地圖載入完成後的處理
                map.whenReady(function() {
                    debugLog('地圖準備就緒');
                    // 強制重新計算地圖大小
                    setTimeout(function() {
                        map.invalidateSize();
                    }, 100);
                });
                
            } catch (error) {
                debugLog('地圖初始化錯誤:', error);
                document.getElementById('resource-list').innerHTML = '<div class="loading" style="color: red;">地圖初始化失敗: ' + error.message + '</div>';
            }
        }
        
        // 創建標記
        function createMarkers() {
            resources.forEach(resource => {
                // 創建自定義圖標
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background-color: ${categoryColors[resource.category]};
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        border: 2px solid white;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    "></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                // 創建標記
                const marker = L.marker([resource.lat, resource.lng], { icon: icon });
                
                // 創建彈出窗口內容
                const popupContent = `
                    <div class="popup-content">
                        <h3>${resource.name}</h3>
                        <p><strong>類型:</strong> ${categoryNames[resource.category]}</p>
                        <p><strong>地址:</strong> ${resource.address}</p>
                        <p><strong>電話:</strong> ${resource.phone}</p>
                        <div>
                            <button class="route-btn" onclick="showRoute('${resource.address}')">
                                Google Maps 導航
                            </button>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent, {
                    className: 'custom-popup'
                });
                
                // 標記點擊事件
                marker.on('click', function() {
                    updateActiveResourceItem(resource.id);
                });
                
                // 添加到標記圖層
                markersLayer.addLayer(marker);
                
                // 存儲標記信息
                markers.push({
                    marker: marker,
                    resource: resource
                });
            });
        }
        
        // 顯示路線
        function showRoute(address) {
            const googleMapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(address)}`;
            window.open(googleMapsUrl, '_blank');
        }
        
        // 更新資源列表
        function updateResourceList(filteredResources) {
            const resourceList = document.getElementById('resource-list');
            resourceList.innerHTML = '';
            
            if (filteredResources.length === 0) {
                resourceList.innerHTML = '<div class="loading">沒有找到符合條件的資源</div>';
                return;
            }
            
            filteredResources.forEach(resource => {
                const resourceItem = document.createElement('div');
                resourceItem.className = 'resource-item';
                resourceItem.id = `resource-${resource.id}`;
                resourceItem.innerHTML = `
                    <strong>${resource.name}</strong><br>
                    <small>${categoryNames[resource.category]} | ${resource.address}</small>
                `;
                
                // 點擊列表項目跳轉到對應的標記
                resourceItem.addEventListener('click', function() {
                    const markerInfo = markers.find(m => m.resource.id === resource.id);
                    if (markerInfo) {
                        map.setView([resource.lat, resource.lng], 16);
                        markerInfo.marker.openPopup();
                        updateActiveResourceItem(resource.id);
                    }
                });
                
                resourceList.appendChild(resourceItem);
            });
        }
        
        // 更新活動資源項目
        function updateActiveResourceItem(resourceId) {
            document.querySelectorAll('.resource-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.getElementById(`resource-${resourceId}`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
        
        // 過濾資源
        function filterResources() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            const activeCategory = document.querySelector('.category-btn.active').dataset.category;
            
            // 過濾資源
            const filteredResources = resources.filter(resource => {
                // 類別過濾
                const categoryMatch = activeCategory === 'all' || resource.category === activeCategory;
                
                // 搜尋文字過濾
                const textMatch = searchText === '' ||
                    resource.name.toLowerCase().includes(searchText) ||
                    resource.address.toLowerCase().includes(searchText) ||
                    resource.phone.toLowerCase().includes(searchText) ||
                    (categoryNames[resource.category] && categoryNames[resource.category].toLowerCase().includes(searchText));
                
                return categoryMatch && textMatch;
            });
            
            // 清除現有標記
            markersLayer.clearLayers();
            
            // 重新添加過濾後的標記
            markers.forEach(markerInfo => {
                const visible = filteredResources.some(r => r.id === markerInfo.resource.id);
                if (visible) {
                    markersLayer.addLayer(markerInfo.marker);
                }
            });
            
            // 更新資源列表
            updateResourceList(filteredResources);
        }
        
        // 綁定事件監聽器
        function bindEventListeners() {
            // 搜尋輸入框
            document.getElementById('search-input').addEventListener('input', filterResources);
            
            // 類別過濾按鈕
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterResources();
                });
            });
        }
        
        // 全域函數
        window.showRoute = showRoute;
        
        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM 載入完成，初始化應用程序');
            initApp();
        });
    </script>
</body>
</html>
