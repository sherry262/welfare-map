<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>福利資源地圖</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <style>
        /* 自定義應用樣式 */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        header {
            background-color: #4285F4;
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 300px;
            background-color: #f8f9fa;
            padding: 15px;
            overflow-y: auto;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        
        #map {
            flex: 1;
            height: 100%;
            min-height: 400px;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-section h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #4285F4;
        }
        
        .resource-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }
        
        .resource-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .resource-item:hover {
            background-color: #f0f7ff;
        }
        
        .resource-item.active {
            background-color: #e3f2fd;
            border-left: 4px solid #4285F4;
        }
        
        .search-box {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .category-btn {
            background-color: #f1f3f4;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 12px;
        }
        
        .category-btn:hover {
            background-color: #e0e0e0;
        }
        
        .category-btn.active {
            background-color: #4285F4;
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* 自定義彈出窗口樣式 */
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .popup-content h3 {
            margin: 0 0 10px 0;
            color: #4285F4;
            font-size: 16px;
        }
        
        .popup-content p {
            margin: 5px 0;
            font-size: 13px;
        }
        
        .route-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 5px 2px 0 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .route-btn:hover {
            background-color: #3367d6;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: auto;
                max-height: 200px;
            }
            .category-btn {
                font-size: 11px;
                padding: 4px 8px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>福利資源地圖</h1>
    </header>
    
    <div class="container">
        <div class="sidebar">
            <div class="filter-section">
                <h3>搜尋資源</h3>
                <input type="text" class="search-box" id="search-input" placeholder="搜尋關鍵字、地址或服務">
            </div>
            
            <div class="filter-section">
                <h3>資源類型</h3>
                <div class="category-filter" id="category-filters">
                    <button class="category-btn active" data-category="all">全部</button>
                    <button class="category-btn" data-category="foundation">基金會</button>
                    <button class="category-btn" data-category="chief">里長</button>
                    <button class="category-btn" data-category="church">教會</button>
                    <button class="category-btn" data-category="locksmith">鎖匠</button>
                    <button class="category-btn" data-category="temple">宮廟</button>
                    <button class="category-btn" data-category="lawyer">律師事務所</button>
                </div>
            </div>
            
            <div class="filter-section">
                <h3>資源列表</h3>
                <div class="resource-list" id="resource-list">
                    <div class="loading">正在載入地圖...</div>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <script>
        // 調試模式
        const DEBUG = true;
        
        function debugLog(...args) {
            if (DEBUG) {
                console.log(`[${new Date().toISOString()}]`, ...args);
            }
        }
        
        // 資源數據和變量
        let resources = [];
        let markers = [];
        let map;
        let markersLayer;
        
        // 資源類別對應的顏色
        const categoryColors = {
            foundation: '#FF5722',    // 橙色 - 基金會
            chief: '#4CAF50',         // 綠色 - 里長
            church: '#2196F3',        // 藍色 - 教會
            locksmith: '#FFC107',     // 黃色 - 鎖匠
            temple: '#9C27B0',        // 紫色 - 宮廟
            lawyer: '#FF9800'         // 橘色 - 律師事務所
        };
        
        // 資源類別對應的中文名稱
        const categoryNames = {
            foundation: '基金會',
            chief: '里長',
            church: '教會',
            locksmith: '鎖匠',
            temple: '宮廟',
            lawyer: '律師事務所'
        };

        // 預設資源數據（桃園市實際坐標）
        const resourcesData = [
            // 教會
            {id: 'CH001', name: '財團法人中國基督教靈糧世界佈道會桃園市府靈糧堂', category: 'church', address: '桃園市桃園區縣府路332-4號5樓', phone: '336-5919', lat: 24.9936, lng: 121.3010},
            {id: 'CH002', name: '財團法人桃園市基督教新歌教會', category: 'church', address: '桃園市桃園區國華街2號', phone: '335-7581', lat: 24.9956, lng: 121.2990},
            {id: 'CH003', name: '財團法人天主教麒田教會', category: 'church', address: '桃園市桃園區中山路956巷91弄5號', phone: '370-3517', lat: 24.9916, lng: 121.3030},
            {id: 'CH004', name: '財團法人臺灣省桃園縣中國基督教靈糧世界佈道會桃園靈糧堂', category: 'church', address: '桃園市桃園區中正路1067號5樓', phone: '356-9317', lat: 24.9896, lng: 121.3050},
            {id: 'CH005', name: '財團法人新約教會桃園教會', category: 'church', address: '桃園市桃園區大業路二段58號7樓', phone: '325-2603', lat: 24.9976, lng: 121.2970},

            // 基金會
            {id: 'FD001', name: '財團法人桃園市怡仁愛心基金會', category: 'foundation', address: '桃園市桃園區三民路3段106號15樓', phone: '336-9066', lat: 24.9946, lng: 121.3000},
            {id: 'FD002', name: '財團法人桃園市私立護國宮愛心基金會', category: 'foundation', address: '桃園市桃園區國際路1段401巷123號', phone: '362-1111', lat: 24.9926, lng: 121.3020},
            {id: 'FD003', name: '財團法人桃園市私立簡欣哲社會福利基金會', category: 'foundation', address: '桃園市桃園區復興路180號6樓', phone: '336-6512', lat: 24.9966, lng: 121.2980},
            {id: 'FD004', name: '財團法人桃園市私立景福宮慈善基金會', category: 'foundation', address: '桃園市桃園區中正路208號', phone: '332-4672', lat: 24.9906, lng: 121.3040},
            {id: 'FD005', name: '財團法人桃園市私立天立社會福利基金會', category: 'foundation', address: '桃園市桃園區樹仁三街601號', phone: '367-7666', lat: 24.9886, lng: 121.3060},

            // 鎖匠
            {id: 'LK001', name: '鎖庫智能家電子鎖體驗館桃園旗艦店', category: 'locksmith', address: '桃園市桃園區春日路455號', phone: '347-6369', lat: 24.9956, lng: 121.3000},
            {id: 'LK002', name: '關外高手刻印鎖店', category: 'locksmith', address: '桃園市桃園區長春路126號', phone: '333-9876', lat: 24.9936, lng: 121.3020},
            {id: 'LK003', name: '建成鎖行', category: 'locksmith', address: '桃園市桃園區建國路53號', phone: '364-5866', lat: 24.9916, lng: 121.3040},
            {id: 'LK004', name: '永吉鎖匙刻印行', category: 'locksmith', address: '桃園市桃園區永安路632號', phone: '355-3141', lat: 24.9976, lng: 121.2980},
            {id: 'LK005', name: '振聲鎖印行', category: 'locksmith', address: '桃園市桃園區復興路468號', phone: '0955-271938', lat: 24.9896, lng: 121.3060},

            // 里長
            {id: 'CV001', name: '大林里里長', category: 'chief', address: '桃園市桃園區樹仁三街68號', phone: '363-9988', lat: 24.9946, lng: 121.2990},
            {id: 'CV002', name: '大樹里里長', category: 'chief', address: '桃園市桃園區樹仁二街176號', phone: '0919-354002', lat: 24.9926, lng: 121.3010},
            {id: 'CV003', name: '大豐里里長', category: 'chief', address: '桃園市桃園區樹林四街38巷12號', phone: '366-5511', lat: 24.9966, lng: 121.3030},
            {id: 'CV004', name: '建國里里長', category: 'chief', address: '桃園市桃園區林森路68巷1弄6號', phone: '361-0068', lat: 24.9906, lng: 121.3050},
            {id: 'CV005', name: '雲林里里長', category: 'chief', address: '桃園市桃園區延平路103號', phone: '363-2233', lat: 24.9886, lng: 121.2970},

            // 宮廟
            {id: 'TP001', name: '護國宮', category: 'temple', address: '桃園區國際路1段401巷123號', phone: '367-7405', lat: 24.9936, lng: 121.3000},
            {id: 'TP002', name: '桃園賜安府', category: 'temple', address: '桃園市桃園區國強一街254號', phone: '369-0926', lat: 24.9916, lng: 121.3020},
            {id: 'TP003', name: '桃園慈護宮', category: 'temple', address: '桃園市桃園區復興路275號', phone: '332-1498', lat: 24.9956, lng: 121.2995},
            {id: 'TP004', name: '景福宮', category: 'temple', address: '桃園市桃園區中正路208號', phone: '333-7552', lat: 24.9906, lng: 121.3040},

            // 律師事務所
            {id: 'LW001', name: '財團法人法律扶助基金會(桃園分會)', category: 'lawyer', address: '桃園市桃園區復興路110號12樓', phone: '334-6500', lat: 24.9956, lng: 121.2990},
            {id: 'LW002', name: '捷泰法律事務所', category: 'lawyer', address: '桃園市桃園區文中路493號5樓', phone: '369-5206', lat: 24.9926, lng: 121.3010},
            {id: 'LW003', name: '元麒法律事務所', category: 'lawyer', address: '桃園市桃園區守法路42號1樓', phone: '334-3276', lat: 24.9946, lng: 121.3030},
            {id: 'LW004', name: '達觀法律事務所', category: 'lawyer', address: '桃園市桃園區縣府路312號之3樓', phone: '338-8898', lat: 24.9966, lng: 121.3050},
            {id: 'LW005', name: '上善法律律師事務所', category: 'lawyer', address: '桃園市桃園區縣府路212號2F-2', phone: '347-8776', lat: 24.9906, lng: 121.2980},
            {id: 'LW006', name: '尚理律師事務所', category: 'lawyer', address: '桃園市桃園區中山北路2號', phone: '331-7600', lat: 24.9886, lng: 121.3040},
            {id: 'LW007', name: '陳袓德律師事務所', category: 'lawyer', address: '桃園市桃園區三民路3段168號', phone: '335-9211', lat: 24.9976, lng: 121.3060}
        ];
        
        // 等待 Leaflet 載入後初始化
        function initApp() {
            debugLog("初始化應用程序");
            
            if (typeof L === 'undefined') {
                debugLog("Leaflet 尚未載入，重試中...");
                setTimeout(initApp, 100);
                return;
            }
            
            // 創建地圖，中心點設在桃園市
            map = L.map('map').setView([24.9936, 121.3010], 13);
            
            // 添加 OpenStreetMap 圖層
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetMap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            
            // 創建標記圖層群組
            markersLayer = L.layerGroup().addTo(map);
            
            resources = resourcesData;
            
            // 創建標記
            createMarkers();
            
            // 更新資源列表
            updateResourceList(resources);
            
            // 綁定事件監聽器
            bindEventListeners();
            
            debugLog(`成功載入 ${resources.length} 個資源`);
        }
        
        // 創建標記
        function createMarkers() {
            resources.forEach(resource => {
                // 創建自定義圖標
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background-color: ${categoryColors[resource.category]};
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        border: 2px solid white;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    "></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                // 創建標記
                const marker = L.marker([resource.lat, resource.lng], { icon: icon });
                
                // 創建彈出窗口內容
                const popupContent = `
                    <div class="popup-content">
                        <h3>${resource.name}</h3>
                        <p><strong>類型:</strong> ${categoryNames[resource.category]}</p>
                        <p><strong>地址:</strong> ${resource.address}</p>
                        <p><strong>電話:</strong> ${resource.phone}</p>
                        <div>
                            <button class="route-btn" onclick="showRoute('${resource.address}')">
                                Google Maps 導航
                            </button>
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent, {
                    className: 'custom-popup'
                });
                
                // 標記點擊事件
                marker.on('click', function() {
                    updateActiveResourceItem(resource.id);
                });
                
                // 添加到標記圖層
                markersLayer.addLayer(marker);
                
                // 存儲標記信息
                markers.push({
                    marker: marker,
                    resource: resource
                });
            });
        }
        
        // 顯示路線
        function showRoute(address) {
            const googleMapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(address)}`;
            window.open(googleMapsUrl, '_blank');
        }
        
        // 更新資源列表
        function updateResourceList(filteredResources) {
            const resourceList = document.getElementById('resource-list');
            resourceList.innerHTML = '';
            
            if (filteredResources.length === 0) {
                resourceList.innerHTML = '<div class="loading">沒有找到符合條件的資源</div>';
                return;
            }
            
            filteredResources.forEach(resource => {
                const resourceItem = document.createElement('div');
                resourceItem.className = 'resource-item';
                resourceItem.id = `resource-${resource.id}`;
                resourceItem.innerHTML = `
                    <strong>${resource.name}</strong><br>
                    <small>${categoryNames[resource.category]} | ${resource.address}</small>
                `;
                
                // 點擊列表項目跳轉到對應的標記
                resourceItem.addEventListener('click', function() {
                    const markerInfo = markers.find(m => m.resource.id === resource.id);
                    if (markerInfo) {
                        map.setView([resource.lat, resource.lng], 16);
                        markerInfo.marker.openPopup();
                        updateActiveResourceItem(resource.id);
                    }
                });
                
                resourceList.appendChild(resourceItem);
            });
        }
        
        // 更新活動資源項目
        function updateActiveResourceItem(resourceId) {
            document.querySelectorAll('.resource-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.getElementById(`resource-${resourceId}`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
        
        // 過濾資源
        function filterResources() {
            const searchText = document.getElementById('search-input').value.toLowerCase();
            const activeCategory = document.querySelector('.category-btn.active').dataset.category;
            
            // 過濾資源
            const filteredResources = resources.filter(resource => {
                // 類別過濾
                const categoryMatch = activeCategory === 'all' || resource.category === activeCategory;
                
                // 搜尋文字過濾
                const textMatch = searchText === '' ||
                    resource.name.toLowerCase().includes(searchText) ||
                    resource.address.toLowerCase().includes(searchText) ||
                    resource.phone.toLowerCase().includes(searchText) ||
                    (categoryNames[resource.category] && categoryNames[resource.category].toLowerCase().includes(searchText));
                
                return categoryMatch && textMatch;
            });
            
            // 清除現有標記
            markersLayer.clearLayers();
            
            // 重新添加過濾後的標記
            markers.forEach(markerInfo => {
                const visible = filteredResources.some(r => r.id === markerInfo.resource.id);
                if (visible) {
                    markersLayer.addLayer(markerInfo.marker);
                }
            });
            
            // 更新資源列表
            updateResourceList(filteredResources);
        }
        
        // 綁定事件監聽器
        function bindEventListeners() {
            // 搜尋輸入框
            document.getElementById('search-input').addEventListener('input', filterResources);
            
            // 類別過濾按鈕
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterResources();
                });
            });
        }
        
        // 全域函數
        window.showRoute = showRoute;
        
        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM 載入完成，初始化應用程序');
            initApp();
        });
    </script>
</body>
</html>
